<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#0a0a0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>BLR.AI — Events</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0b;
  --surface: #111114;
  --card: #17171c;
  --border: #2a2a35;
  --accent: #00ff88;
  --accent2: #00c8ff;
  --muted: #555566;
  --text: #e8e8f0;
  --text-dim: #8888aa;
  --hackathon: #ff6b35;
  --meetup: #00ff88;
  --workshop: #a78bfa;
  --conference: #00c8ff;
  --danger: #ff4455;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html { height: 100%; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Syne', sans-serif;
  min-height: 100%;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none; z-index: 0;
}

/* ── Layout ── */
.app { display: flex; flex-direction: column; min-height: 100vh; position: relative; z-index: 1; }

/* ── Top bar ── */
.topbar {
  padding: calc(var(--safe-top) + 14px) 16px 14px;
  background: rgba(10,10,11,0.92);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 50;
  display: flex; align-items: center; gap: 12px;
}
.logo-mark { font-size: 20px; font-weight: 800; letter-spacing: -1px; color: var(--text); line-height: 1; }
.logo-mark span { color: var(--accent); }
.logo-sub { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }

.scan-pill {
  display: flex; align-items: center; gap: 6px;
  font-family: 'Space Mono', monospace; font-size: 10px;
  padding: 6px 11px; border-radius: 20px;
  border: 1px solid var(--accent); background: rgba(0,255,136,0.08);
  color: var(--accent); cursor: pointer; transition: all 0.2s;
  white-space: nowrap;
}
.scan-pill:hover { background: rgba(0,255,136,0.18); }
.scan-pill:disabled { opacity: 0.4; cursor: not-allowed; }
.scan-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
.scan-dot.idle { background: var(--muted); }
.scan-dot.live { animation: pulse 2s infinite; }
.scan-dot.scanning { background: var(--accent2); animation: pulse 0.5s infinite; }
.scan-dot.error { background: var(--danger); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }
.spin { display:inline-block; animation: spin 0.9s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.add-btn {
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--accent); color: var(--bg);
  border: none; font-size: 20px; font-weight: 300;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: background 0.2s; flex-shrink: 0;
}
.add-btn:hover { background: #00cc6e; }

/* ── Stats row ── */
.stats-row {
  display: flex; gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
}
.stat-item {
  flex: 1; text-align: center;
  padding: 12px 8px;
  border-right: 1px solid var(--border);
}
.stat-item:last-child { border-right: none; }
.stat-num { font-size: 22px; font-weight: 800; color: var(--accent); line-height: 1; }
.stat-label { font-family: 'Space Mono', monospace; font-size: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 2px; }

/* ── Scan progress ── */
.scan-banner {
  display: none; background: var(--surface);
  border-bottom: 2px solid var(--accent2);
  padding: 10px 16px;
  font-family: 'Space Mono', monospace; font-size: 11px;
}
.scan-banner.visible { display: block; }
.scan-banner-title { color: var(--accent2); font-size: 9px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.scan-log-mini { color: var(--text-dim); max-height: 80px; overflow-y: auto; line-height: 1.9; }
.scan-log-mini .ll { display: block; }
.scan-log-mini .ll.ok { color: var(--accent); }
.scan-log-mini .ll.err { color: var(--danger); }
.scan-log-mini .ll.info { color: var(--accent2); }

/* ── Filter/search bar ── */
.filter-bar {
  padding: 10px 12px;
  display: flex; gap: 8px; align-items: center;
  border-bottom: 1px solid var(--border);
  overflow-x: auto; -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.filter-bar::-webkit-scrollbar { display: none; }

.search-input {
  background: var(--card); border: 1px solid var(--border);
  color: var(--text); font-family: 'Space Mono', monospace; font-size: 12px;
  padding: 8px 12px; border-radius: 20px; outline: none;
  transition: border-color 0.2s; min-width: 130px; flex: 1;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--muted); }

.chip {
  font-family: 'Space Mono', monospace; font-size: 10px;
  padding: 7px 12px; border-radius: 20px;
  border: 1px solid var(--border); background: var(--card);
  color: var(--text-dim); cursor: pointer; transition: all 0.18s;
  white-space: nowrap; flex-shrink: 0;
}
.chip:hover { border-color: var(--accent); color: var(--accent); }
.chip.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 700; }
.chip[data-type="hackathon"].active { background: var(--hackathon); border-color: var(--hackathon); color: #fff; }
.chip[data-type="meetup"].active { background: var(--meetup); border-color: var(--meetup); color: var(--bg); }
.chip[data-type="workshop"].active { background: var(--workshop); border-color: var(--workshop); color: #fff; }
.chip[data-type="conference"].active { background: var(--conference); border-color: var(--conference); color: var(--bg); }

/* ── Sort/count bar ── */
.sort-bar {
  padding: 8px 16px;
  display: flex; align-items: center; gap: 8px;
  border-bottom: 1px solid var(--border);
  font-family: 'Space Mono', monospace; font-size: 10px;
}
.sort-lbl { color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; }
.sort-opt { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 3px 6px; border-radius: 3px; font-family: 'Space Mono', monospace; font-size: 10px; transition: color 0.15s; }
.sort-opt.active, .sort-opt:hover { color: var(--accent); }
.sort-right { margin-left: auto; color: var(--muted); }
.past-toggle { background: none; border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; padding: 3px 8px; border-radius: 10px; font-family: 'Space Mono', monospace; font-size: 9px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.15s; }
.past-toggle.active { border-color: var(--muted); color: var(--text-dim); }

/* ── Event cards ── */
.events-list { padding: 12px; display: flex; flex-direction: column; gap: 10px; padding-bottom: calc(var(--safe-bottom) + 20px); }

.event-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 16px;
  cursor: pointer; transition: all 0.18s;
  position: relative; overflow: hidden;
  animation: slideIn 0.25s ease both;
}
.event-card::before { content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: var(--card-accent, var(--accent)); }
.event-card:active { transform: scale(0.98); opacity: 0.9; }
.event-card.ai-found::after {
  content: 'AI'; position: absolute; top: 10px; right: 10px;
  font-family: 'Space Mono', monospace; font-size: 8px;
  color: var(--accent2); border: 1px solid var(--accent2);
  padding: 2px 5px; border-radius: 2px; opacity: 0.6;
}
@keyframes slideIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

.card-row1 { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 10px; }
.type-badge {
  font-family: 'Space Mono', monospace; font-size: 8px; font-weight: 700;
  padding: 3px 7px; border-radius: 3px; letter-spacing: 2px; text-transform: uppercase; flex-shrink: 0;
}
.days-badge { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--text-dim); background: var(--surface); border: 1px solid var(--border); padding: 3px 7px; border-radius: 3px; white-space: nowrap; }
.days-badge.soon { color: var(--accent); border-color: var(--accent); background: rgba(0,255,136,0.08); }
.days-badge.past { color: var(--muted); }

.card-name { font-size: 15px; font-weight: 700; line-height: 1.3; margin-bottom: 4px; }
.card-org { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--text-dim); margin-bottom: 10px; }

.card-meta { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
.meta-row { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--text-dim); display: flex; align-items: center; gap: 6px; }
.meta-ico { color: var(--muted); width: 12px; text-align: center; flex-shrink: 0; }

.card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px; }
.tag { font-family: 'Space Mono', monospace; font-size: 8px; color: var(--text-dim); background: var(--surface); border: 1px solid var(--border); padding: 2px 6px; border-radius: 2px; text-transform: uppercase; letter-spacing: 1px; }

.card-footer { display: flex; align-items: center; justify-content: space-between; padding-top: 10px; border-top: 1px solid var(--border); gap: 8px; }
.spots { font-family: 'Space Mono', monospace; font-size: 9px; }
.spots.open { color: var(--accent); }
.spots.limited { color: var(--hackathon); }
.spots.closed { color: var(--muted); }
.reg-link { font-family: 'Space Mono', monospace; font-size: 9px; padding: 5px 10px; border-radius: 4px; border: 1px solid currentColor; cursor: pointer; background: transparent; transition: all 0.15s; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; color: var(--accent); }
.reg-link:active { background: rgba(0,255,136,0.12); }
.reg-link.disabled { color: var(--muted); pointer-events: none; }

/* ── Empty state ── */
.empty { text-align: center; padding: 60px 20px; }
.empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.3; }
.empty-title { font-size: 16px; font-weight: 700; color: var(--text-dim); margin-bottom: 6px; }
.empty-sub { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); line-height: 1.8; }

/* ── Loading ── */
.loading { text-align: center; padding: 60px 20px; }
.loading-spinner { font-size: 28px; animation: spin 1s linear infinite; display: inline-block; color: var(--accent); margin-bottom: 12px; }
.loading-text { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); }

/* ── Bottom sheet modal ── */
.sheet-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 200; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
.sheet-overlay.open { display: flex; align-items: flex-end; justify-content: center; }

.sheet {
  background: var(--card); border-radius: 18px 18px 0 0;
  border: 1px solid var(--border); border-bottom: none;
  width: 100%; max-width: 600px;
  max-height: 92vh; overflow-y: auto;
  animation: sheetUp 0.28s cubic-bezier(0.32,0.72,0,1);
  padding-bottom: var(--safe-bottom);
}
@keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.sheet-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 0; }
.sheet-header { padding: 16px 20px 0; display: flex; justify-content: space-between; align-items: center; }
.sheet-title { font-family: 'Space Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 3px; color: var(--accent); }
.sheet-close { background: none; border: none; color: var(--muted); font-size: 22px; cursor: pointer; line-height: 1; padding: 4px; }
.sheet-body { padding: 16px 20px 24px; }

/* Detail sheet */
.detail-name { font-size: 20px; font-weight: 800; line-height: 1.25; margin-bottom: 6px; }
.detail-org { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-dim); margin-bottom: 16px; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
.detail-cell { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; }
.detail-cell-label { font-family: 'Space Mono', monospace; font-size: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 3px; }
.detail-cell-val { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text); }
.detail-source { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted); margin-bottom: 14px; }
.detail-source a { color: var(--accent2); }
.detail-desc { font-size: 14px; color: var(--text-dim); line-height: 1.7; margin-bottom: 16px; }
.detail-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 20px; }
.detail-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* Form */
.form-group { margin-bottom: 14px; }
.form-label { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; display: block; margin-bottom: 5px; }
.form-control { background: var(--surface); border: 1px solid var(--border); color: var(--text); font-family: 'Space Mono', monospace; font-size: 12px; padding: 10px 12px; border-radius: 6px; outline: none; transition: border-color 0.2s; width: 100%; -webkit-appearance: none; }
.form-control:focus { border-color: var(--accent); }
.form-control::placeholder { color: var(--muted); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* Buttons */
.btn { font-family: 'Space Mono', monospace; font-size: 11px; padding: 11px 18px; border-radius: 8px; cursor: pointer; transition: all 0.18s; letter-spacing: 1px; border: none; text-transform: uppercase; text-align: center; text-decoration: none; display: inline-block; }
.btn-primary { background: var(--accent); color: var(--bg); font-weight: 700; flex: 1; }
.btn-primary:active { background: #00cc6e; }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
.btn-ghost:active { border-color: var(--accent2); color: var(--accent2); }
.btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); }

/* Toast */
.toast { position: fixed; bottom: calc(var(--safe-bottom) + 20px); left: 50%; transform: translateX(-50%) translateY(20px); background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px 18px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text); z-index: 500; opacity: 0; transition: all 0.25s; white-space: nowrap; pointer-events: none; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.ok { border-color: var(--accent); color: var(--accent); }
.toast.err { border-color: var(--danger); color: var(--danger); }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>
<div class="app">

  <!-- Top Bar -->
  <div class="topbar">
    <div>
      <div class="logo-mark">BLR<span>.</span>AI</div>
      <div class="logo-sub">Bangalore AI Events</div>
    </div>
    <div class="topbar-right">
      <button class="scan-pill" id="scanBtn" onclick="startScan()">
        <span class="scan-dot idle" id="scanDot"></span>
        <span id="scanBtnLabel">Scan</span>
      </button>
      <button class="add-btn" onclick="openAddSheet()" aria-label="Add event">+</button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-item"><div class="stat-num" id="s-upcoming">—</div><div class="stat-label">Upcoming</div></div>
    <div class="stat-item"><div class="stat-num" id="s-hackathons">—</div><div class="stat-label">Hackathons</div></div>
    <div class="stat-item"><div class="stat-num" id="s-ai">—</div><div class="stat-label">AI Found</div></div>
    <div class="stat-item"><div class="stat-num" id="s-total">—</div><div class="stat-label">Total</div></div>
  </div>

  <!-- Scan Banner -->
  <div class="scan-banner" id="scanBanner">
    <div class="scan-banner-title"><span class="spin">◌</span> AI Web Scanner</div>
    <div class="scan-log-mini" id="scanLog"></div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <input class="search-input" id="searchInput" placeholder="Search…" oninput="applyFilters()" />
    <button class="chip active" data-type="all" onclick="setFilter(this)">All</button>
    <button class="chip" data-type="hackathon" onclick="setFilter(this)">Hack</button>
    <button class="chip" data-type="meetup" onclick="setFilter(this)">Meetup</button>
    <button class="chip" data-type="workshop" onclick="setFilter(this)">Workshop</button>
    <button class="chip" data-type="conference" onclick="setFilter(this)">Conf</button>
  </div>

  <!-- Sort bar -->
  <div class="sort-bar">
    <span class="sort-lbl">Sort</span>
    <button class="sort-opt active" data-sort="date" onclick="setSort(this)">Date</button>
    <button class="sort-opt" data-sort="name" onclick="setSort(this)">Name</button>
    <button class="sort-opt" data-sort="type" onclick="setSort(this)">Type</button>
    <div class="sort-right">
      <button class="past-toggle" id="pastToggle" onclick="togglePast()">Past</button>
      &nbsp;<span id="eventCount" style="color:var(--muted)"></span>
    </div>
  </div>

  <!-- Events -->
  <div class="events-list" id="eventsList">
    <div class="loading">
      <div class="loading-spinner">◌</div>
      <div class="loading-text">Loading events...</div>
    </div>
  </div>
</div>

<!-- Detail Sheet -->
<div class="sheet-overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="sheet" id="detailSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title" id="d-type">// Event</span>
      <button class="sheet-close" onclick="closeSheetById('detailOverlay')">✕</button>
    </div>
    <div class="sheet-body">
      <div class="detail-name" id="d-name"></div>
      <div class="detail-org" id="d-org"></div>
      <div class="detail-grid" id="d-grid"></div>
      <div class="detail-source" id="d-source"></div>
      <div class="detail-desc" id="d-desc"></div>
      <div class="detail-tags" id="d-tags"></div>
      <div class="detail-actions">
        <a class="btn btn-primary" id="d-regbtn" href="#" target="_blank" rel="noopener">Register →</a>
        <button class="btn btn-ghost" onclick="openEditFromDetail()">Edit</button>
        <button class="btn btn-danger" onclick="deleteFromDetail()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Sheet -->
<div class="sheet-overlay" id="addOverlay" onclick="closeDetail(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="sheet-title" id="addSheetTitle">// New Event</span>
      <button class="sheet-close" onclick="closeSheetById('addOverlay')">✕</button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Event Name *</label>
        <input class="form-control" id="f-name" placeholder="GenAI Hackathon Bangalore" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-control" id="f-type">
            <option value="hackathon">Hackathon</option>
            <option value="meetup">Meetup</option>
            <option value="workshop">Workshop</option>
            <option value="conference">Conference</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Mode</label>
          <select class="form-control" id="f-mode">
            <option value="In-Person">In-Person</option>
            <option value="Online">Online</option>
            <option value="Hybrid">Hybrid</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Organizer</label>
        <input class="form-control" id="f-org" placeholder="e.g. TensorFlow UG Bangalore" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Start Date *</label>
          <input class="form-control" id="f-date" type="date" />
        </div>
        <div class="form-group">
          <label class="form-label">End Date</label>
          <input class="form-control" id="f-enddate" type="date" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Venue</label>
        <input class="form-control" id="f-venue" placeholder="Microsoft Reactor, Bellandur" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Registration</label>
          <select class="form-control" id="f-reg">
            <option value="open">Open</option>
            <option value="limited">Limited</option>
            <option value="closed">Closed</option>
            <option value="free">Free</option>
          </select>
        </div>
        <div class="form-group" style="grid-column:1/-1">
          <label class="form-label">Event URL</label>
          <input class="form-control" id="f-url" type="url" placeholder="https://..." />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Tags (comma-separated)</label>
        <input class="form-control" id="f-tags" placeholder="LLMs, GenAI, MLOps..." />
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" id="f-desc" rows="3" placeholder="Brief description..."></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-ghost" onclick="closeSheetById('addOverlay')" style="flex:1">Cancel</button>
        <button class="btn btn-primary" onclick="submitEvent()">Save Event</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ── State ──────────────────────────────────────────────────────────────────
let allEvents = [];
let activeFilter = 'all';
let activeSort = 'date';
let showPast = false;
let detailId = null;
let editId = null;

const TYPE_COLORS = {
  hackathon: '#ff6b35',
  meetup: '#00ff88',
  workshop: '#a78bfa',
  conference: '#00c8ff',
};

// ── Helpers ────────────────────────────────────────────────────────────────
function daysFromNow(dateStr) {
  const t = new Date(); t.setHours(0,0,0,0);
  const d = new Date(dateStr); d.setHours(0,0,0,0);
  return Math.round((d - t) / 86400000);
}
function fmtDate(ds) {
  if (!ds) return '';
  return new Date(ds).toLocaleDateString('en-IN', { day:'numeric', month:'short', year:'numeric' });
}
function esc(s) {
  const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
}
function regLabel(r) {
  return {open:'Open',limited:'Limited',closed:'Closed',free:'Free'}[r] || r;
}
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' '+type : '');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ── API ────────────────────────────────────────────────────────────────────
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function loadEvents() {
  try {
    const data = await api('GET', '/api/events');
    allEvents = data.events || [];
    renderEvents();
    updateStats();
    checkScanStatus(data.meta);
  } catch (err) {
    document.getElementById('eventsList').innerHTML = `<div class="empty"><div class="empty-icon">⚠</div><div class="empty-title">Failed to load</div><div class="empty-sub">${esc(err.message)}</div></div>`;
  }
}

// ── Scan ───────────────────────────────────────────────────────────────────
let scanning = false;

function setScanUI(state, label) {
  const dot = document.getElementById('scanDot');
  const lbl = document.getElementById('scanBtnLabel');
  const btn = document.getElementById('scanBtn');
  dot.className = 'scan-dot ' + state;
  lbl.textContent = label;
  btn.disabled = state === 'scanning';
}

function logLine(msg, cls='') {
  const el = document.getElementById('scanLog');
  const s = document.createElement('span');
  s.className = 'll ' + cls;
  s.textContent = '> ' + msg;
  el.appendChild(s);
  el.scrollTop = el.scrollHeight;
}

function checkScanStatus(meta) {
  if (!meta) return;
  if (meta.lastScan) {
    const elapsed = Date.now() - new Date(meta.lastScan).getTime();
    const h = Math.round(elapsed / 3600000);
    setScanUI('live', h === 0 ? 'Live' : `${h}h ago`);
  }
}

function startScan() {
  if (scanning) return;
  scanning = true;
  document.getElementById('scanBanner').classList.add('visible');
  document.getElementById('scanLog').innerHTML = '';
  setScanUI('scanning', 'Scanning...');
  logLine('Starting AI web scan...', 'info');

  const es = new EventSource('/api/scan');
  es.onmessage = (e) => {
    const line = e.data;
    if (line === 'done') {
      es.close();
      scanning = false;
      loadEvents();
      setTimeout(() => document.getElementById('scanBanner').classList.remove('visible'), 4000);
      setScanUI('live', 'Live');
      return;
    }
    const [type, ...rest] = line.split(':');
    const msg = rest.join(':');
    if (type === 'info') logLine(msg, 'info');
    else if (type === 'ok') logLine(msg, 'ok');
    else if (type === 'err') { logLine(msg, 'err'); }
    else logLine(line);
  };
  es.onerror = () => {
    es.close();
    scanning = false;
    setScanUI('error', 'Error');
    logLine('Connection lost', 'err');
    setTimeout(() => document.getElementById('scanBanner').classList.remove('visible'), 3000);
  };
}

// ── Render ─────────────────────────────────────────────────────────────────
function filteredEvents() {
  let list = [...allEvents];
  if (activeFilter !== 'all') list = list.filter(e => e.type === activeFilter);
  if (!showPast) list = list.filter(e => daysFromNow(e.date) >= 0);
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
  if (q) list = list.filter(e =>
    e.name.toLowerCase().includes(q) ||
    (e.org||'').toLowerCase().includes(q) ||
    (e.tags||[]).some(t => t.toLowerCase().includes(q)) ||
    (e.desc||'').toLowerCase().includes(q)
  );
  list.sort((a, b) => {
    if (activeSort === 'date') return new Date(a.date) - new Date(b.date);
    if (activeSort === 'name') return a.name.localeCompare(b.name);
    if (activeSort === 'type') return a.type.localeCompare(b.type);
    return 0;
  });
  return list;
}

function updateStats() {
  document.getElementById('s-upcoming').textContent = allEvents.filter(e => daysFromNow(e.date) >= 0).length;
  document.getElementById('s-hackathons').textContent = allEvents.filter(e => e.type === 'hackathon').length;
  document.getElementById('s-ai').textContent = allEvents.filter(e => e.aiFound).length;
  document.getElementById('s-total').textContent = allEvents.length;
}

function renderEvents() {
  const list = filteredEvents();
  const el = document.getElementById('eventsList');
  document.getElementById('eventCount').textContent = list.length + (list.length === 1 ? ' event' : ' events');

  if (list.length === 0) {
    el.innerHTML = `<div class="empty">
      <div class="empty-icon">◎</div>
      <div class="empty-title">No events found</div>
      <div class="empty-sub">Tap "Scan" to auto-discover Bangalore AI events<br>or tap + to add one manually</div>
    </div>`;
    return;
  }

  el.innerHTML = list.map((e, i) => {
    const color = TYPE_COLORS[e.type] || '#888';
    const diff = daysFromNow(e.date);
    const dateLbl = e.endDate ? `${fmtDate(e.date)} – ${fmtDate(e.endDate)}` : fmtDate(e.date);
    const tags = (e.tags||[]).slice(0,3).map(t => `<span class="tag">${esc(t)}</span>`).join('');
    const spotsClass = {open:'open',limited:'limited',closed:'closed',free:'open'}[e.reg]||'open';
    const badge = diff < 0 ? `<span class="days-badge past">Ended</span>` :
                  diff === 0 ? `<span class="days-badge soon">TODAY</span>` :
                  diff <= 7 ? `<span class="days-badge soon">In ${diff}d</span>` :
                  `<span class="days-badge">In ${diff}d</span>`;
    return `
      <div class="event-card ${e.aiFound?'ai-found':''}" style="--card-accent:${color};animation-delay:${Math.min(i,10)*0.035}s" onclick="openDetail(${e.id})">
        <div class="card-row1">
          <span class="type-badge" style="background:${color}22;color:${color}">${e.type}</span>
          ${badge}
        </div>
        <div class="card-name">${esc(e.name)}</div>
        <div class="card-org">${esc(e.org||'—')}</div>
        <div class="card-meta">
          <div class="meta-row"><span class="meta-ico">◷</span>${dateLbl}</div>
          <div class="meta-row"><span class="meta-ico">⌘</span>${esc(e.venue||'TBD')} · ${e.mode}</div>
        </div>
        ${tags ? `<div class="card-tags">${tags}</div>` : ''}
        <div class="card-footer">
          <span class="spots ${spotsClass}">${regLabel(e.reg)}</span>
          ${e.url ? `<a class="reg-link" href="${esc(e.url)}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Register →</a>` : `<span class="reg-link disabled">No link</span>`}
        </div>
      </div>`;
  }).join('');
}

// ── Filters ────────────────────────────────────────────────────────────────
function setFilter(btn) {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  activeFilter = btn.dataset.type;
  renderEvents();
}
function setSort(btn) {
  document.querySelectorAll('.sort-opt').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeSort = btn.dataset.sort;
  renderEvents();
}
function applyFilters() { renderEvents(); }
function togglePast() {
  showPast = !showPast;
  const t = document.getElementById('pastToggle');
  t.classList.toggle('active', showPast);
  t.textContent = showPast ? 'Hide Past' : 'Past';
  renderEvents();
}

// ── Detail Sheet ───────────────────────────────────────────────────────────
function openDetail(id) {
  detailId = id;
  const e = allEvents.find(ev => ev.id === id);
  if (!e) return;
  const color = TYPE_COLORS[e.type] || '#888';
  const diff = daysFromNow(e.date);
  const dateLbl = e.endDate ? `${fmtDate(e.date)} – ${fmtDate(e.endDate)}` : fmtDate(e.date);

  document.getElementById('d-type').textContent = `// ${e.type}`;
  document.getElementById('d-type').style.color = color;
  document.getElementById('d-name').textContent = e.name;
  document.getElementById('d-org').textContent = e.org || 'Unknown Organizer';
  document.getElementById('d-grid').innerHTML = `
    <div class="detail-cell"><div class="detail-cell-label">Date</div><div class="detail-cell-val">${dateLbl}</div></div>
    <div class="detail-cell"><div class="detail-cell-label">Status</div><div class="detail-cell-val" style="color:${diff<0?'var(--muted)':'var(--accent)'}">${diff<0?'Past':diff===0?'TODAY':'In '+diff+' days'}</div></div>
    <div class="detail-cell"><div class="detail-cell-label">Venue</div><div class="detail-cell-val">${esc(e.venue||'TBD')}</div></div>
    <div class="detail-cell"><div class="detail-cell-label">Mode</div><div class="detail-cell-val">${e.mode}</div></div>`;
  document.getElementById('d-source').innerHTML = e.aiFound
    ? `<span style="color:var(--accent2)">◈ AI-discovered${e.scannedAt?' on '+e.scannedAt:''}</span>${e.url?` · <a href="${esc(e.url)}" target="_blank">source →</a>`:''}`
    : `<span style="color:var(--muted)">◈ Manually added</span>`;
  document.getElementById('d-desc').textContent = e.desc || 'No description.';
  document.getElementById('d-tags').innerHTML = (e.tags||[]).map(t => `<span class="tag">${esc(t)}</span>`).join('');
  const rb = document.getElementById('d-regbtn');
  if (e.url) { rb.href = e.url; rb.style.display = ''; } else { rb.style.display = 'none'; }
  document.getElementById('detailOverlay').classList.add('open');
}

function openEditFromDetail() {
  const e = allEvents.find(ev => ev.id === detailId);
  if (!e) return;
  closeSheetById('detailOverlay');
  openAddSheet(e);
}

async function deleteFromDetail() {
  if (!confirm('Delete this event?')) return;
  try {
    await api('DELETE', `/api/events/${detailId}`);
    allEvents = allEvents.filter(e => e.id !== detailId);
    closeSheetById('detailOverlay');
    renderEvents(); updateStats();
    showToast('Event deleted', 'ok');
  } catch(err) { showToast('Delete failed: ' + err.message, 'err'); }
}

// ── Add/Edit Sheet ─────────────────────────────────────────────────────────
function openAddSheet(ev) {
  editId = ev ? ev.id : null;
  document.getElementById('addSheetTitle').textContent = editId ? '// Edit Event' : '// New Event';
  document.getElementById('f-name').value = ev?.name || '';
  document.getElementById('f-type').value = ev?.type || 'hackathon';
  document.getElementById('f-org').value = ev?.org || '';
  document.getElementById('f-date').value = ev?.date || '';
  document.getElementById('f-enddate').value = ev?.endDate || '';
  document.getElementById('f-venue').value = ev?.venue || '';
  document.getElementById('f-mode').value = ev?.mode || 'In-Person';
  document.getElementById('f-reg').value = ev?.reg || 'open';
  document.getElementById('f-url').value = ev?.url || '';
  document.getElementById('f-tags').value = (ev?.tags||[]).join(', ');
  document.getElementById('f-desc').value = ev?.desc || '';
  document.getElementById('addOverlay').classList.add('open');
}

async function submitEvent() {
  const name = document.getElementById('f-name').value.trim();
  const date = document.getElementById('f-date').value;
  if (!name || !date) { showToast('Name and date required', 'err'); return; }
  const payload = {
    name, date,
    type: document.getElementById('f-type').value,
    org: document.getElementById('f-org').value.trim(),
    endDate: document.getElementById('f-enddate').value,
    venue: document.getElementById('f-venue').value.trim(),
    mode: document.getElementById('f-mode').value,
    reg: document.getElementById('f-reg').value,
    url: document.getElementById('f-url').value.trim(),
    tags: document.getElementById('f-tags').value.split(',').map(t=>t.trim()).filter(Boolean),
    desc: document.getElementById('f-desc').value.trim(),
  };
  try {
    if (editId) {
      const updated = await api('PUT', `/api/events/${editId}`, payload);
      allEvents = allEvents.map(e => e.id === editId ? updated : e);
      showToast('Event updated ✓', 'ok');
    } else {
      const created = await api('POST', '/api/events', payload);
      allEvents.push(created);
      showToast('Event added ✓', 'ok');
    }
    closeSheetById('addOverlay');
    renderEvents(); updateStats();
  } catch(err) { showToast('Error: ' + err.message, 'err'); }
}

// ── Sheet helpers ──────────────────────────────────────────────────────────
function closeSheetById(id) { document.getElementById(id).classList.remove('open'); }
function closeDetail(e) { if (e.target === e.currentTarget) e.currentTarget.classList.remove('open'); }

// ── Boot ───────────────────────────────────────────────────────────────────
loadEvents();
</script>
</body>
</html>
